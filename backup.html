<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backup e Prestação de Contas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h2 {
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    button {
      padding: 10px;
      margin: 10px 5px;
      border: none;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    pre {
      background-color: #eee;
      padding: 10px;
      overflow-x: auto;
      max-height: 300px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div><strong>Usuário:</strong> <span id="usuarioLogado"></span></div>
    <div><strong>Hora:</strong> <span id="horaAtual"></span></div>
  </div>

  <h2>Backup e Prestação de Contas</h2>

  <button onclick="fazerBackup()">Fazer Backup Completo do Sistema</button>
  <button onclick="baixarBackup()">Baixar Backup (JSON)</button>
  <button onclick="restaurarBackup()">Restaurar Backup</button>
  <button onclick="zerarCaixa()">Zerar Caixa</button>
  <button onclick="voltarPainel()">Retornar ao Painel</button>
  <button onclick="voltarLogin()">Voltar ao Login</button>

  <h3>Dados do Caixa</h3>
  <pre id="dadosCaixa"></pre>

  <script>
    const usuario = localStorage.getItem('usuarioLogado') || 'Nenhum';
    document.getElementById('usuarioLogado').textContent = usuario;

    function atualizarHora() {
      const agora = new Date();
      const hora = agora.toLocaleTimeString('pt-BR');
      document.getElementById('horaAtual').textContent = hora;
    }
    setInterval(atualizarHora, 1000);
    atualizarHora();

    function fazerBackup() {
      const backup = {
        vendedores: JSON.parse(localStorage.getItem('vendedores') || '[]'),
        receitas: JSON.parse(localStorage.getItem('receitas') || '[]'),
        despesas: JSON.parse(localStorage.getItem('despesas') || '[]'),
        caixaHistorico: JSON.parse(localStorage.getItem('historicoCaixa') || '[]'),
        saldoAnterior: JSON.parse(localStorage.getItem('saldoAnterior') || '0')
      };
      localStorage.setItem('backupSistema', JSON.stringify(backup));
      alert("Backup salvo com sucesso!");
      exibirCaixa();
    }

    function baixarBackup() {
      const backup = localStorage.getItem('backupSistema');
      const blob = new Blob([backup], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'backup_sistema.json';
      link.click();
    }

    function restaurarBackup() {
      const backup = JSON.parse(localStorage.getItem('backupSistema') || '{}');
      if (Object.keys(backup).length === 0) {
        alert('Nenhum backup encontrado.');
        return;
      }

      localStorage.setItem('vendedores', JSON.stringify(backup.vendedores));
      localStorage.setItem('receitas', JSON.stringify(backup.receitas));
      localStorage.setItem('despesas', JSON.stringify(backup.despesas));
      localStorage.setItem('historicoCaixa', JSON.stringify(backup.caixaHistorico));
      localStorage.setItem('saldoAnterior', JSON.stringify(backup.saldoAnterior));

      alert('Backup restaurado com sucesso!');
      exibirCaixa();
    }

    function zerarCaixa() {
      const senha = prompt("Digite a senha para zerar o caixa:");
      if (senha !== "12345") {
        alert("Senha incorreta.");
        return;
      }
      localStorage.removeItem('receitas');
      localStorage.removeItem('despesas');
      localStorage.removeItem('historicoCaixa');
      localStorage.removeItem('saldoAnterior');

      // Zera histórico de vendas de cada vendedor
      const vendedores = JSON.parse(localStorage.getItem('vendedores') || '[]');
      vendedores.forEach(v => v.historico = []);
      localStorage.setItem('vendedores', JSON.stringify(vendedores));

      alert("Caixa zerado com sucesso!");
      exibirCaixa();
    }

    function voltarLogin() {
      window.location.href = 'index.html';
    }

    function voltarPainel() {
      window.location.href = 'painel.html';
    }

    function exibirCaixa() {
      const vendedores = JSON.parse(localStorage.getItem('vendedores') || '[]');
      const receitas = JSON.parse(localStorage.getItem('receitas') || '[]');
      const despesas = JSON.parse(localStorage.getItem('despesas') || '[]');

      const totalApurado = vendedores.reduce((total, v) => {
        return total + (v.historico || []).reduce((soma, h) => soma + (parseFloat(h.apurou) || 0), 0);
      }, 0);

      const totalReceitas = receitas.reduce((soma, r) => soma + (parseFloat(r.valor) || 0), 0);
      const totalDespesas = despesas.reduce((soma, d) => soma + (parseFloat(d.valor) || 0), 0);
      const saldoFinal = totalReceitas + totalApurado - totalDespesas;

      const dados = `
SALDO ANTERIOR: R$ ${totalReceitas.toFixed(2)}
TOTAL APURADO: R$ ${totalApurado.toFixed(2)}
TOTAL DESPESAS: R$ ${totalDespesas.toFixed(2)}
SALDO FINAL: R$ ${saldoFinal.toFixed(2)}
      `.trim();

      document.getElementById('dadosCaixa').textContent = dados;
    }

    // Exibir ao carregar
    exibirCaixa();
  </script>
</body>
</html>
